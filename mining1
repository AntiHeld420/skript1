-- raum_füllen.lua mit automatischer Blocknachfüllung

-- Funktion: Sicher vorwärts bewegen
function sicherVor()
    while not turtle.forward() do
        turtle.dig()
        sleep(0.5)
    end
end

-- Funktion: Sicher aufsteigen
function sicherHoch()
    while not turtle.up() do
        turtle.digUp()
        sleep(0.5)
    end
end

-- Funktion: Umdrehen (180 Grad)
function umdrehen()
    turtle.turnLeft()
    turtle.turnLeft()
end

-- Funktion: Blöcke auffüllen aus Kiste hinter Startpunkt
function auffullenAusKiste()
    print("Hole neue Blocke aus der Kiste...")

    -- aktuelle Position speichern
    umdrehen()
    sicherVor()  -- Zur Kiste hinter Start

    -- Blöcke aufnehmen (aus jedem Slot in der Kiste)
    for i = 1, 16 do
        turtle.select(i)
        turtle.suck()
    end

    -- Zurück zur Arbeitsposition
    umdrehen()
    sicherVor()
    turtle.select(1) -- zurück zu Slot 1
end

-- Funktion: prüfen, ob noch Blöcke vorhanden
function hatBlocke()
    for i = 1, 16 do
        if turtle.getItemCount(i) > 0 then
            return true
        end
    end
    return false
end

-- Funktion: versuche Block unter Turtle zu platzieren
function platzierenUnten()
    for i = 1, 16 do
        turtle.select(i)
        if turtle.getItemCount() > 0 then
            if turtle.placeDown() then
                return true
            end
        end
    end
    return false
end

-- Eingabe der Raumgröße
print("Gib die Seitenlange des Raums (n) ein:")
local eingabe = read()
local n = tonumber(eingabe)

if not n or n < 1 then
    print("Ungueltige Eingabe.")
    return
end

print("Starte Fuellen von " .. n .. " x " .. n .. " x " .. n .. " Blocken.")

-- Hauptschleife: Ebene für Ebene
for ebene = 1, n do
    for reihe = 1, n do
        for spalte = 1, n do
            if not hatBlocke() then
                auffullenAusKiste()
                if not hatBlocke() then
                    print("Keine Blocke mehr verfuegbar. Abbruch.")
                    return
                end
            end

            platzierenUnten()

            if spalte < n then
                sicherVor()
            end
        end

        -- Zeilenwechsel
        if reihe < n then
            if reihe % 2 == 1 then
                turtle.turnRight()
                sicherVor()
                turtle.turnRight()
            else
                turtle.turnLeft()
                sicherVor()
                turtle.turnLeft()
            end
        end
    end

    -- Wieder zum Start der Ebene
    if n % 2 == 1 then
        turtle.turnRight()
        for i = 1, n - 1 do sicherVor() end
        turtle.turnRight()
    else
        turtle.turnLeft()
        for i = 1, n - 1 do sicherVor() end
        turtle.turnLeft()
    end

    -- Nächste Ebene
    if ebene < n then
        sicherHoch()
    end
end

print("Fertig! Der Raum wurde vollstaendig gefuellt.")
